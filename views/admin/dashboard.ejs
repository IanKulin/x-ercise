<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - X-ercise</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>X-ercise Admin</h1>
            <div class="admin-actions">
                <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
                <a href="/admin/sets/new" class="btn btn-primary">Add Set</a>
                <form id="import-form" action="/admin/sets/import" method="POST" enctype="multipart/form-data" style="display: inline;">
                    <label for="import-file" class="btn btn-primary" style="cursor: pointer;">Import Set</label>
                    <input type="file" id="import-file" name="setFile" accept=".json" style="display: none;">
                </form>
            </div>
        </header>

        <main class="admin-main">
            <% if (sets.length === 0) { %>
                <div class="empty-state">
                    <p>No exercise sets found.</p>
                    <a href="/admin/sets/new" class="btn btn-primary">Create Your First Set</a>
                </div>
            <% } else { %>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Slug</th>
                            <th>Exercises</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% sets.forEach(set => { %>
                            <tr>
                                <td><strong><%= set.name %></strong></td>
                                <td><code><%= set.slug %></code></td>
                                <td><%= set.exercise_count %></td>
                                <td><%= new Date(set.created_at).toLocaleDateString('en-AU') %></td>
                                <td class="actions">
                                    <a href="/admin/sets/<%= set.id %>/export" class="btn btn-small" download title="Export">üì•</a>
                                    <a href="/admin/sets/<%= set.id %>/edit" class="btn btn-small" title="Edit">‚úèÔ∏è</a>
                                    <button class="btn btn-small btn-danger" onclick="deleteSet(<%= set.id %>, '<%= set.name %>')" title="Delete">üóëÔ∏è</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } %>
        </main>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Exercise Set?</h2>
            <p id="deleteMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Handle import file selection
        document.getElementById('import-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // Basic validation
                if (!data.name || !data.slug || !Array.isArray(data.exercises)) {
                    alert('Invalid JSON format. File must contain "name", "slug", and "exercises" array.');
                    e.target.value = '';
                    return;
                }

                if (data.exercises.length === 0) {
                    alert('Exercise set must contain at least one exercise.');
                    e.target.value = '';
                    return;
                }

                // Submit form
                e.target.form.submit();
            } catch (err) {
                alert('Invalid JSON file: ' + err.message);
                e.target.value = '';
            }
        });

        let deleteSetId = null;

        function deleteSet(id, name) {
            deleteSetId = id;
            document.getElementById('deleteMessage').textContent =
                `Are you sure you want to delete "${name}"? This action cannot be undone.`;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            deleteSetId = null;
            document.getElementById('deleteModal').style.display = 'none';
        }

        async function confirmDelete() {
            if (!deleteSetId) return;

            try {
                const response = await fetch(`/admin/sets/${deleteSetId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error deleting set: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting set: ' + error.message);
            }

            closeDeleteModal();
        }

        // Close modal on background click
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target === modal) {
                closeDeleteModal();
            }
        };
    </script>
</body>
</html>
